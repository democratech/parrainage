{% extends 'base.html' %}
{% block title %}{{ object }}{% endblock %}
{% block page-header-title %}
<h1>{{ object.first_name }} {{ object.family_name }}</h1>
{% endblock %}
{% block page-content %}
<div class="container-fluid">
    <div class="col-xs-12 col-md-4">
	<h2>Infos de contact</h2>
	<p><strong>Email:</strong> {{ object.public_email|urlize }}<br/>
	<strong>Téléphone:</strong> <a href="tel:{{ object.public_phone }}">{{ object.public_phone }}</a><br/>
	<strong>Site web:</strong> {{ object.public_website|urlize }}<br/>
	{% if object.city %}
	<strong>Adresse:</strong> {{ object.city_address|linebreaksbr }}
	{{ object.city_zipcode }} {{ object.city }}<br/>
	{% endif %}
	</p>
	{% if user.is_authenticated %}
	<p><strong>Email privé:</strong> {{ object.private_email|urlize }}<br/>
	<strong>Téléphone privé:</strong> <a href="tel:{{ object.private_phone }}">{{ object.private_phone }}</a></p>
	{% endif %}
	<p><strong>Réseaux sociaux:</strong>
	<a title="Recherche sur Faceebook" href="https://www.facebook.com/search/all/?q={{ object.first_name|urlencode }}%20{{ object.family_name|urlencode }}">Facebook</a>
	<a title="Recherche sur Twitter" href="https://twitter.com/search?f=users&q={{ object.first_name|urlencode }}%20{{ object.family_name|urlencode }}&src=typd">Twitter</a></p>

    </div>
    <div class="col-xs-12 col-md-4">
	<h2>Autres infos</h2>
	<p><strong>Date de naissance:</strong> {{ object.birthdate }} ({{ object.birthdate|timesince }})<br/>
	<strong>Couleur politique de sa liste:</strong> {{ object.nuance_politique|default:"inconnue" }}<br/>
        <strong>Commentaires:</strong> {{ object.comment }}<br/>
	<strong>Fonction:</strong> {{ object.get_role_display }}<br/>
	{% if object.city %}
	<strong>Commune:</strong> {{ object.city }}<br/>
	<strong>Population commune:</strong> {{ object.city_size }}<br/>
        <strong>Horaires mairie:</strong> <a target="_blank" href="https://lannuaire.service-public.fr/recherche?whoWhat=mairie&where={{ object.city_zipcode|urlencode }}{{ " "|urlencode }}{{ object.city|urlencode }}">ouvrir</a><br/>
	{% endif %}
	<strong>Département:</strong> <a href="{% url 'elu-list' %}?department={{ object.department }}&sort=priority">{{ object.department }}</a>
	</p>
    </div>
    <div class="col-xs-12 col-md-4">
	<h2>Statut</h2>
	{% if user.is_authenticated %}
	<p><strong>Statut:</strong> {{ object.get_status_display }}<br/>
	<strong>Assigné à:</strong> {% include 'userlink.html' with u=object.assigned_to %}</p>
	<p>
	{% if object.assigned_to == user %}
	<form method="POST">
	    {% csrf_token %} 
	    <input type="hidden" name="action" value="unassign"/>
	    <button type="submit" class="btn btn-primary">Supprimer l'assignation</button>
	</form>
	{% else %}
	<form method="POST">
	    {% csrf_token %} 
	    <input type="hidden" name="action" value="assign"/>
	    <button type="submit" class="btn btn-primary">M'assigner cet élu</button>
	</form>
	{% endif %}
	</p>
	{% else %}
	<p><strong>Statut:</strong> {{ object.get_public_status_display }}</p>
	{% endif %}
	{% if perms.app.can_change_elu %}
	<p>
	<a href="/admin/app/elu/{{ object.id }}/">Page de l'élu sur
	    l'interface d'administration</a><br/>
	<a href="/u/{{ object.id }}/{{ object.private_token }}/">Formulaire
	    de réponse</a> (lien privé)<br/>
	<strong>Nombre d'assignations publiques</strong>:
	{{ object.public_assign_count }}
	</p>
	{% endif %}
    </div>

    {% if user.is_authenticated %}
    <div class="col-xs-12">
	<h2>Historique</h2>
	<table class="table table-striped">
	    <tr>
		<th>Horodatage</th>
		<th>Qui</th>
		<th>Contenu de la note</th>
	    </tr>
	    {% for note in object.notes.all %}
	    <tr>
		<td>{{ note.timestamp }}<br/>(il y a {{ note.timestamp|timesince }})</td>
		<td>{% include 'userlink.html' with u=note.user %}</td>
		<td>{{ note.note|linebreaksbr }}</td>
	    </tr>
	    {% endfor %}
	</table>
    </div>
    <div class="col-xs-12">
	<h3>Ajout d'une note et mise à jour du statut</h3>
	<form method="POST">
	    <div class="form-group">
		<label for="newStatus">Nouveau statut:</label>
		<select class="form-control" id="newStatus" name="status">
		    <option value="" selected>Statut inchangé</option>
		    {% for value, text in object.STATUS_CHOICES %}
		    <option value="{{ value }}">{{ text }}</option>
		    {% endfor %}
		</select>
	    </div>
	    <div class="form-group">
		<label for="newNote">Nouvelle note:</label>
		<textarea class="form-control" id="newNote" name="note" rows="3"></textarea>
	    </div>
	    {% csrf_token %} 
	    <input type="hidden" name="action" value="add_note"/>
	    <button type="submit" class="btn btn-primary">Mettre à jour le
		statut et/ou ajouter la note</button>
	</form>
    </div>
    <div class="col-xs-12">
	<p></p>
	<h3>Mise à jour des coordonnées privées</h3>
	<form method="POST" class="form-inline">
	    <div class="form-group">
		<label for="newEmail">Email privé:</label>
		<input type="text" class="form-control" id="newEmail" name="private_email" value="{{ object.private_email }}">
	    </div>
	    <div class="form-group">
		<label for="newPhone">Téléphone privé:</label>
		<input type="text" class="form-control" id="newPhone" name="private_phone" value="{{ object.private_phone }}">
	    </div>
	    {% csrf_token %} 
	    <input type="hidden" name="action" value="update_contact"/>
	    <button type="submit" class="btn btn-primary">Mettre à jour les coordonnées</button>
	</form>
    </div>
    {% endif %}
    {% if object.role == 'M' %}
    {% if user.is_authenticated or request.GET.assigned %}
    <div class="col-xs-12 m-t-1">
	{% if assigned %}
	<h3>Actions possibles</h3>
	<p><a href="{% url 'assign' %}?action=unassign&elu_id={{ object.id }}"
	    class="btn btn-primary">Finalement, je ne contacterai pas cet élu</a>
	   <a href="{% url 'assign' %}?action=assign&forcenew=1"
	   class="btn btn-primary">J'ai contacté cet élu, j'en veux un autre</a>
	</p>
	{% endif %}
	<h3>Aide au démarchage téléphonique</h3>
	<p>D'abord vérifiez les <a target="_blank" href="https://lannuaire.service-public.fr/recherche?whoWhat=mairie&where={{ object.city_zipcode|urlencode }}{{ " "|urlencode }}{{ object.city|urlencode }}">a href="">horaires de la mairie</a> et planifiez votre appel à une heure
	d'ouverture. Ensuite voici ce à quoi pourrait ressembler votre
	entretien téléphonique:</p>
	<table class="table table-sm table-hover">
	    <tr><th>Vous</th><td>Bonjour, je vourai parler à
		    {{ object.first_name }}.</td></tr>
	    <tr><th>Secrétariat</th><td>De la part de qui ?</td></tr>
	    <tr><th>Vous</th><td><em>Répondez par votre prénom</em><td></tr>
	    <tr class="bg-info text-white"><th colspan="2">Si on ne vous passe pas le maire</th></tr>
	    <tr><th>Secrétariat</th><td>Désolé il n'est pas là.
		    Que puis-je faire pour vous ?</td></tr>
	    <tr><th>Vous</th><td>Oui. En fait je suis un des 127.000
		participants à LaPrimaire.org, la première primaire
		citoyenne organisée sur Internet en vue des élections
		présidentielles. Cette expérience réellement démocratique
		a permis de désigner Charlotte Marchandise-Franquet comme
		candidate. Normalement vous avez du recevoir le 28 février
		un courrier électronique de « Aude Favre
		&lt;soutien@lavoiecitoyenne.fr&gt; » intitulé
		« {% if object.gender == 'F' %}M.{% else %}Mme{% endif %}
		{{ object.family_name|title }}, vos électeurs vous
		remercieront de votre courage » à ce sujet. Le message
		vous invitait à faire suivre le courrier au maire afin
		qu'il puisse remplir rapidement le formulaire de réponse.
		À ce jour,
		{% if object.gender == 'F' %}M.{% else %}Mme{% endif %} {{ object.family_name|title }}
		n'y a pas encore répondu. Pouvez-vous vérifier que vous
		avez bien reçu ce message et qu'il a été transmis au maire ?
		</td></tr>
	    <tr><th>Secrétaire</th><td><em>Cherche sur son
			ordinateur</em>. C'est bon, je l'ai retrouvé. Je
		    vais le faire suivre.</td></tr>
	    <tr><th>Vous</th><td>Merci. À quel moment puis-je rappeler
		    pour m'entretenir quelques minutes avec
		{% if object.gender == 'F' %}M.{% else %}Mme{% endif %}
		{{ object.family_name|title }} ?<br/>
		<em>Vous prenez note de quand vous pouvez rappeler et
		    clôture poliment la conversation.</em>
		</td></tr>
	    <tr class="bg-info text-white"><th colspan="2">Si on vous passe le maire</th></tr>
	    <tr class="bg-info text-white"><th colspan="2">À compléter...</th></tr>
	    <!-- <tr><th>Vous</th><td><em>On commence part -->

	</table>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}
